<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>모의 주식 시뮬레이터</title>
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 20px;
    background: #fff;
    color: #222;
  }
  body.dark {
    background: #121212;
    color: #eee;
  }
  button {
    margin: 5px;
    padding: 8px 12px;
    cursor: pointer;
  }
  select, input {
    padding: 5px;
    margin: 5px 10px 5px 0;
  }
  #stockInfo div {
    margin-bottom: 5px;
  }
  #logArea {
    width: 100%;
    height: 120px;
    margin-top: 15px;
    background: #eee;
    color: #222;
    font-family: monospace;
    resize: none;
  }
  body.dark #logArea {
    background: #222;
    color: #eee;
  }
  #news {
    margin-top: 15px;
    font-weight: bold;
    height: 24px;
    color: #d00;
  }
  #summary {
    margin-bottom: 15px;
  }
  #summary span {
    margin-right: 15px;
    font-weight: bold;
  }
</style>
</head>
<body class="light">

<h1>모의 주식 시뮬레이터</h1>

<div id="summary">
  <span>보유현금: <span id="cash">0</span> 원</span>
  <span>총평가금액: <span id="totalValue">0</span> 원</span>
  <span>수익률: <span id="roi">0.00</span> %</span>
  <button id="darkModeToggle">다크모드 토글</button>
</div>

<select id="stockSelect"></select>
<input type="number" id="amount" min="1" value="1" />
<button id="buyBtn">매수</button>
<button id="sellBtn">매도</button>
<button id="shortBuyBtn">숏 매수</button>
<button id="shortSellBtn">숏 매도</button>

<div id="stockInfo"></div>

<canvas id="stockChart" width="800" height="400"></canvas>

<div id="news"></div>

<textarea id="logArea" readonly></textarea>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // 초기 주가
  const initialPrices = {
    "삼성전자": 88000,
    "카카오": 35000,
    "LG화학": 900000,
    "네이버": 400000,
    "현대차": 230000,
    "기아": 88000,
    "셀트리온": 230000,
    "엔씨소프트": 150000,
    "삼성바이오": 120000,
    "카카오뱅크": 32000,
    "SK하이닉스": 90000,
    "POSCO": 300000,
    "현대모비스": 320000,
    "한화솔루션": 72000,
    "LG전자": 90000,
    "초저가주식": 1000
  };

  // 뉴스 리스트
  const newsList = [
    "삼성전자, 신제품 출시로 기대감↑",
    "카카오, 플랫폼 서비스 강화 발표",
    "LG화학, 배터리 생산 확대 소식",
    "네이버, AI 기술 도입 가속",
    "현대차, 전기차 모델 공개",
    "기아, 신차 판매 증가 전망",
    "셀트리온, 신약 임상 결과 긍정적",
    "엔씨소프트, 인기 게임 업데이트",
    "삼성바이오, 생산량 확대 계획",
    "카카오뱅크, 신규 고객 급증",
    "SK하이닉스, 반도체 투자 확대",
    "POSCO, 친환경 사업 추진",
    "현대모비스, 자율주행 기술 개발",
    "한화솔루션, 태양광 사업 호조",
    "LG전자, 스마트 가전 판매 신장",
    "초저가주식, 대량 매수세 유입"
  ];

  let prices = JSON.parse(localStorage.getItem('stockPrices')) || {...initialPrices};
  let stocks = Object.entries(prices).map(([name, price]) => ({ name, price }));

  let portfolio = JSON.parse(localStorage.getItem('portfolio')) || {};
  let cash = parseInt(localStorage.getItem('cash') || "100000");
  let logs = JSON.parse(localStorage.getItem('logs')) || [];
  let currentStock = stocks[0].name;
  let chartsData = {};
  let currentChart = null;

  const feeRate = 0.05;

  // 차트 생성 및 갱신
  const ctx = document.getElementById('stockChart').getContext('2d');
  function createChart(stockName) {
    if(currentChart) currentChart.destroy();
    const data = {
      labels: [],
      datasets: [{
        label: stockName,
        data: [],
        borderColor: document.body.classList.contains('light') ? '#008000' : 'lime',
        backgroundColor: 'transparent',
        tension: 0.3,
        pointRadius: 0,
        borderWidth: 2,
      }]
    };
    currentChart = new Chart(ctx, {
      type: 'line',
      data,
      options: {
        animation: false,
        scales: {
          x: { display: false },
          y: { beginAtZero: false }
        },
        plugins: {
          legend: { labels: { color: document.body.classList.contains('light') ? '#222' : '#eee' } }
        }
      }
    });
    chartsData[stockName] = chartsData[stockName] || [];
  }
  function updateChartData(stockName, price) {
    if(!chartsData[stockName]) chartsData[stockName] = [];
    let arr = chartsData[stockName];
    arr.push(price);
    if(arr.length > 50) arr.shift();
    if(currentStock === stockName && currentChart) {
      currentChart.data.labels = arr.map(() => '');
      currentChart.data.datasets[0].data = arr;
      currentChart.update();
    }
  }

  // UI 업데이트
  function updateUI() {
    document.getElementById('cash').textContent = cash.toLocaleString();
    let totalVal = cash;
    for (const s of stocks) {
      const hold = portfolio[s.name]?.long || 0;
      const shortHold = portfolio[s.name]?.short || 0;
      totalVal += s.price * hold;
      if(shortHold) {
        const avgShortPrice = portfolio[s.name].shortAvgPrice || s.price;
        totalVal += (avgShortPrice - s.price) * shortHold;
      }
    }
    document.getElementById('totalValue').textContent = totalVal.toLocaleString();
    let roiVal = ((totalVal - 100000) / 100000 * 100).toFixed(2);
    document.getElementById('roi').textContent = roiVal;

    // 종목별 보유량 표시
    const infoDiv = document.getElementById('stockInfo');
    infoDiv.innerHTML = '';
    for (const s of stocks) {
      const longAmt = portfolio[s.name]?.long || 0;
      const shortAmt = portfolio[s.name]?.short || 0;
      const item = document.createElement('div');
      item.innerHTML = `<b>${s.name}</b> 현재가: ${s.price.toLocaleString()}원 
        <span>롱 보유: ${longAmt}</span> <span>숏 보유: ${shortAmt}</span>`;
      infoDiv.appendChild(item);
    }
  }

  // 로그 기록
  function logAction(text) {
    const time = new Date().toLocaleTimeString();
    logs.push(`[${time}] ${text}`);
    if(logs.length > 100) logs.shift();
    const logArea = document.getElementById('logArea');
    logArea.value = logs.join('\n');
    logArea.scrollTop = logArea.scrollHeight;
    saveAll();
  }

  // 저장
  function saveAll() {
    localStorage.setItem('portfolio', JSON.stringify(portfolio));
    localStorage.setItem('cash', cash);
    localStorage.setItem('logs', JSON.stringify(logs));
    const updatedPrices = {};
    stocks.forEach(s => updatedPrices[s.name] = s.price);
    localStorage.setItem('stockPrices', JSON.stringify(updatedPrices));
  }

  // 종목 선택 드롭다운 초기화 및 변경 이벤트
  function populateStockSelect() {
    const select = document.getElementById('stockSelect');
    select.innerHTML = '';
    for(const s of stocks) {
      const option = document.createElement('option');
      option.value = s.name;
      option.textContent = s.name;
      select.appendChild(option);
    }
    select.value = currentStock;
  }
  document.getElementById('stockSelect').addEventListener('change', e => {
    currentStock = e.target.value;
    createChart(currentStock);
    const pricesArr = chartsData[currentStock] || [];
    if(currentChart) {
      currentChart.data.labels = pricesArr.map(() => '');
      currentChart.data.datasets[0].data = pricesArr;
      currentChart.update();
    }
  });

  // 매수
  function buyStock() {
    const amt = parseInt(document.getElementById('amount').value);
    if(amt <= 0 || isNaN(amt)) return alert("올바른 매수 수량을 입력하세요.");
    const stock = stocks.find(s => s.name === currentStock);
    if(!stock) return;
    const totalCost = Math.floor(stock.price * amt * (1 + feeRate));
    if(cash < totalCost) return alert("현금이 부족합니다.");
    cash -= totalCost;
    if(!portfolio[currentStock]) portfolio[currentStock] = {long:0, short:0, shortAvgPrice:0};
    portfolio[currentStock].long = (portfolio[currentStock].long || 0) + amt;
    logAction(`매수: ${currentStock} ${amt}주, 총 비용 ${totalCost.toLocaleString()}원 (수수료 포함)`);
    updateUI();
    saveAll();
    updateChartData(currentStock, stock.price);
  }

  // 매도
  function sellStock() {
    const amt = parseInt(document.getElementById('amount').value);
    if(amt <= 0 || isNaN(amt)) return alert("올바른 매도 수량을 입력하세요.");
    if(!portfolio[currentStock] || (portfolio[currentStock].long || 0) < amt) return alert("보유 주식이 부족합니다.");
    const stock = stocks.find(s => s.name === currentStock);
    if(!stock) return;
    const revenue = Math.floor(stock.price * amt * (1 - feeRate));
    cash += revenue;
    portfolio[currentStock].long -= amt;
    if(portfolio[currentStock].long === 0) portfolio[currentStock].long = 0;
    logAction(`매도: ${currentStock} ${amt}주, 총 수익 ${revenue.toLocaleString()}원 (수수료 제외)`);
    updateUI();
    saveAll();
    updateChartData(currentStock, stock.price);
  }

  // 숏 매수 (숏 포지션 진입)
  function shortStock() {
    const amt = parseInt(document.getElementById('amount').value);
    if(amt <= 0 || isNaN(amt)) return alert("올바른 수량을 입력하세요.");
    const stock = stocks.find(s => s.name === currentStock);
    if(!stock) return;
    const totalCost = Math.floor(stock.price * amt * (1 + feeRate));
    if(cash < totalCost) return alert("현금이 부족합니다.");
    cash -= totalCost;
    if(!portfolio[currentStock]) portfolio[currentStock] = {long:0, short:0, shortAvgPrice:0};
    // 숏 평균 단가 갱신
    let oldAmt = portfolio[currentStock].short || 0;
    let oldAvg = portfolio[currentStock].shortAvgPrice || 0;
    const newAvg = oldAmt === 0 ? stock.price : ((oldAvg * oldAmt) + (stock.price * amt)) / (oldAmt + amt);
    portfolio[currentStock].shortAvgPrice = newAvg;
    portfolio[currentStock].short = oldAmt + amt;
    logAction(`숏 매수: ${currentStock} ${amt}주, 평균 단가 ${Math.floor(newAvg).toLocaleString()}원 (수수료 포함)`);
    updateUI();
    saveAll();
    updateChartData(currentStock, stock.price);
  }

  // 숏 매도 (숏 포지션 청산)
  function shortSellStock() {
    const amt = parseInt(document.getElementById('amount').value);
    if(amt <= 0 || isNaN(amt)) return alert("올바른 수량을 입력하세요.");
    if(!portfolio[currentStock] || (portfolio[currentStock].short || 0) < amt) return alert("숏 보유 주식이 부족합니다.");
    const stock = stocks.find(s => s.name === currentStock);
    if(!stock) return;
    const avgShortPrice = portfolio[currentStock].shortAvgPrice || stock.price;
    const gainPerShare = avgShortPrice - stock.price;
    if(gainPerShare < 0) return alert("현재 손실 상태입니다. 숏 매도 불가.");
    const gain = Math.floor(gainPerShare * amt * (1 - feeRate));
    cash += gain + Math.floor(stock.price * amt * feeRate);
    portfolio[currentStock].short -= amt;
    if(portfolio[currentStock].short === 0) portfolio[currentStock].shortAvgPrice = 0;
    logAction(`숏 매도: ${currentStock} ${amt}주, 수익 ${gain.toLocaleString()}원 (수수료 포함)`);
    updateUI();
    saveAll();
    updateChartData(currentStock, stock.price);
  }

  // 뉴스 이벤트 띄우기
  function showNews(text) {
    const newsDiv = document.getElementById('news');
    newsDiv.textContent = text;
    setTimeout(() => {
      if(newsDiv.textContent === text) newsDiv.textContent = '';
    }, 5000);
  }

  // 뉴스 이벤트 적용 (12초마다 50% 확률 발생)
  function applyNewsEvent() {
    if(Math.random() > 0.5) {
      const idx = Math.floor(Math.random() * newsList.length);
      const news = newsList[idx];
      showNews(news);
      const sIdx = Math.floor(Math.random() * stocks.length);
      const stock = stocks[sIdx];
      const upDown = Math.random() > 0.5 ? 1 : -1;
      const rate = (Math.random() * 0.3 + 0.2); // 20~50%
      let newPrice;
      if(upDown > 0) {
        newPrice = Math.floor(stock.price * (1 + rate));
      } else {
        newPrice = Math.floor(stock.price * (1 - rate));
        if(newPrice < 1000) newPrice = 1000;
      }
      stock.price = newPrice;
      prices[stock.name] = newPrice;
      updateChartData(stock.name, newPrice);
      logAction(`뉴스 이벤트: ${stock.name} 주가 ${upDown > 0 ? '급등' : '급락'} (${Math.floor(rate*100)}%)`);
    }
    saveAll();
  }

  // 주가 변동 (3초마다, 기본 변동 -0.5% ~ +1.5%)
  function updatePrices() {
    for(const s of stocks) {
      const change = (Math.random() * 0.02 - 0.005);
      let newPrice = Math.floor(s.price * (1 + change));
      if(newPrice < 1000) newPrice = 1000;
      s.price = newPrice;
      prices[s.name] = newPrice;
      updateChartData(s.name, newPrice);
    }
    saveAll();
    updateUI();
  }

  // 다크 모드 토글
  function toggleDarkMode() {
    document.body.classList.toggle('dark');
    document.body.classList.toggle('light');
    if(currentChart) {
      currentChart.data.datasets[0].borderColor = document.body.classList.contains('light') ? '#008000' : 'lime';
      currentChart.options.plugins.legend.labels.color = document.body.classList.contains('light') ? '#222' : '#eee';
      currentChart.update();
    }
  }
  document.getElementById('darkModeToggle').addEventListener('click', toggleDarkMode);

  // 버튼 이벤트 연결
  document.getElementById('buyBtn').addEventListener('click', buyStock);
  document.getElementById('sellBtn').addEventListener('click', sellStock);
  document.getElementById('shortBuyBtn').addEventListener('click', shortStock);
  document.getElementById('shortSellBtn').addEventListener('click', shortSellStock);

  // 초기화
  function init() {
    if(!localStorage.getItem('cash')) localStorage.setItem('cash', cash);
    if(!localStorage.getItem('portfolio')) localStorage.setItem('portfolio', JSON.stringify(portfolio));
    if(!localStorage.getItem('logs')) localStorage.setItem('logs', JSON.stringify(logs));
    if(!localStorage.getItem('stockPrices')) {
      localStorage.setItem('stockPrices', JSON.stringify(prices));
    }
    populateStockSelect();
    createChart(currentStock);
    updateUI();
    const logArea = document.getElementById('logArea');
    logArea.value = logs.join('\n');
    logArea.scrollTop = logArea.scrollHeight;
  }

  init();

  setInterval(updatePrices, 3000);
  setInterval(applyNewsEvent, 12000);

</script>
</body>
</html>
