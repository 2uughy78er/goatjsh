<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>실시간 주식 거래 시뮬레이터</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      display: flex;
      font-family: Arial, sans-serif;
      margin: 0;
    }
    .sidebar {
      width: 180px;
      background: #f5f5f5;
      padding: 10px;
      overflow-y: auto;
    }
    .chart-container {
      flex: 1;
      padding: 20px;
    }
    .stock-list button {
      display: block;
      width: 100%;
      margin-bottom: 5px;
    }
    .controls {
      margin-top: 10px;
    }
    .info {
      margin-top: 10px;
    }
    .log-table, .log-table th, .log-table td {
      border: 1px solid #ccc;
      border-collapse: collapse;
    }
    .log-table th, .log-table td {
      padding: 5px;
    }
    .rankings {
      margin-top: 20px;
      font-size: 14px;
    }
    .max-buy {
      margin-top: 5px;
      font-size: 14px;
      color: #333;
    }
  </style>
</head>
<body>
  <div class="sidebar">
    <h2>종목 선택</h2>
    <div class="stock-list" id="stockButtons"></div>
    <div class="rankings">
      <h3>🏆 수익률 순위</h3>
      <ul id="rankList"></ul>
    </div>
  </div>

  <div class="chart-container">
    <h1 id="stock-title">초기투자</h1>
    <div style="font-size: 18px; margin-bottom: 15px;">
      현재 주가: <span id="currentPrice" style="font-weight: bold;">0</span>원
    </div>

    <div class="controls">
      <input type="number" id="tradeAmount" value="1" min="1" />
      <button onclick="buyStock()">🟢 매수</button>
      <button onclick="sellStock()">🔴 매도</button>
      <div class="max-buy" id="maxBuy"></div>
      <div class="info">
        💰 자금: <span id="cash">0</span>원 |
        💼 보유 수량: <span id="shares">0</span>개<br />
        📈 손익: <span id="profit" style="font-weight: bold;">0원 (0%)</span>
      </div>
    </div>

    <canvas id="stockChart" width="1200" height="400"></canvas>

    <h3>📋 거래 내역</h3>
    <table class="log-table" id="tradeLog">
      <thead>
        <tr>
          <th>시간</th>
          <th>종목</th>
          <th>구분</th>
          <th>단가</th>
          <th>수량</th>
          <th>총액</th>
          <th>손익</th>
          <th>수익률</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    const ctx = document.getElementById('stockChart').getContext('2d');
    const stocks = ['초기투자', '삼성전자', '현대차', 'LG전자', '카카오', '네이버', '셀트리온', 'POSCO', 'SK하이닉스', '기아', '한화솔루션', 'NAVER', '신한지주', 'KB금융', '삼성바이오로직스', '롯데케미칼'];
    const startPrices = {
      '초기투자': 1000, '삼성전자': 60000, '현대차': 220000, 'LG전자': 130000,
      '카카오': 70000, '네이버': 300000, '셀트리온': 250000, 'POSCO': 300000,
      'SK하이닉스': 110000, '기아': 85000, '한화솔루션': 36000,
      'NAVER': 300000, '신한지주': 40000, 'KB금융': 47000,
      '삼성바이오로직스': 850000, '롯데케미칼': 300000
    };
    const userName = '나';
    let currentStock = stocks[0];
    let currentIndex = 50;
    const maxDataLength = 50;
    function getRandomPrice(prevPrice, stockName) {
      let changePercent = stockName === '초기투자' ? (Math.random() * 0.04 - 0.01) : (Math.random() - 0.5) * 0.06;
      let newPrice = prevPrice * (1 + changePercent);
      return Math.max(1, Math.round(newPrice));
    }
    function generateInitialData(startPrice, stockName) {
      const arr = [startPrice];
      for (let i = 1; i < maxDataLength; i++) arr.push(getRandomPrice(arr[i - 1], stockName));
      return arr;
    }
    const stockData = {};
    stocks.forEach(s => stockData[s] = generateInitialData(startPrices[s], s));

    const userHoldings = { cash: 50000, shares: {}, avgBuyPrice: {} };
    stocks.forEach(s => { userHoldings.shares[s] = 0; userHoldings.avgBuyPrice[s] = null; });
    const users = { [userName]: userHoldings };

    function saveUserData() {
      localStorage.setItem("stockSimulatorUserData", JSON.stringify(userHoldings));
    }
    function loadUserData() {
      const data = localStorage.getItem("stockSimulatorUserData");
      if (data) Object.assign(userHoldings, JSON.parse(data));
    }
    loadUserData();

    const labels = Array.from({ length: maxDataLength }, (_, i) => i.toString());
    const data = {
      labels: [...labels],
      datasets: [{
        label: currentStock,
        borderColor: 'rgb(75, 192, 192)',
        backgroundColor: 'rgba(75, 192, 192, 0.2)',
        data: [...stockData[currentStock]],
        tension: 0.3
      }]
    };

    const chart = new Chart(ctx, {
      type: 'line', data: data,
      options: {
        responsive: true, animation: false,
        scales: {
          x: { title: { display: true, text: '시간' } },
          y: { title: { display: true, text: '가격' }, beginAtZero: false }
        }
      }
    });

    stocks.forEach(stock => {
      const btn = document.createElement('button');
      btn.textContent = stock;
      btn.onclick = () => selectStock(stock);
      document.getElementById('stockButtons').appendChild(btn);
    });

    function selectStock(name) {
      currentStock = name;
      currentIndex = stockData[name].length;
      document.getElementById('stock-title').innerText = name;
      data.datasets[0].label = name;
      data.datasets[0].data = stockData[name];
      data.labels = Array.from({ length: stockData[name].length }, (_, i) => i.toString());
      chart.update();
      updateInfo();
    }

    function getCurrentPrice() {
      return stockData[currentStock][stockData[currentStock].length - 1];
    }

    function buyStock() {
      const price = getCurrentPrice();
      const quantity = parseInt(document.getElementById('tradeAmount').value);
      if (quantity <= 0) return alert('1 이상 수량을 입력하세요.');
      const totalCost = price * quantity;
      if (userHoldings.cash >= totalCost) {
        const currentShares = userHoldings.shares[currentStock];
        const currentAvg = userHoldings.avgBuyPrice[currentStock];
        const newTotalShares = currentShares + quantity;
        userHoldings.avgBuyPrice[currentStock] = currentShares === 0 ? price : (currentAvg * currentShares + price * quantity) / newTotalShares;
        userHoldings.cash -= totalCost;
        userHoldings.shares[currentStock] += quantity;
        logTrade("매수", price, quantity, 0, "0%");
        saveUserData();
        updateInfo();
      } else alert("자금이 부족합니다.");
    }

    function sellStock() {
      const quantity = parseInt(document.getElementById('tradeAmount').value);
      if (quantity <= 0) return alert('1 이상 수량을 입력하세요.');
      const owned = userHoldings.shares[currentStock];
      if (owned >= quantity) {
        const sellPrice = getCurrentPrice();
        const buyPrice = userHoldings.avgBuyPrice[currentStock];
        const profitPerShare = sellPrice - buyPrice;
        const profitTotal = profitPerShare * quantity;
        const profitRate = buyPrice === 0 ? 0 : ((profitPerShare / buyPrice) * 100).toFixed(2);
        userHoldings.cash += sellPrice * quantity;
        userHoldings.shares[currentStock] -= quantity;
        if (userHoldings.shares[currentStock] === 0) userHoldings.avgBuyPrice[currentStock] = null;
        logTrade("매도", sellPrice, quantity, profitTotal, profitRate + "%");
        saveUserData();
        updateInfo();
      } else alert("보유 수량이 부족합니다.");
    }

    setInterval(() => {
      stocks.forEach(stock => {
        const prices = stockData[stock];
        const prevPrice = prices[prices.length - 1];
        const newPrice = getRandomPrice(prevPrice, stock);
        prices.push(newPrice);
        if (prices.length > maxDataLength) prices.shift();
      });
      data.labels.push((currentIndex++).toString());
      if (data.labels.length > maxDataLength) data.labels.shift();
      data.datasets[0].data = stockData[currentStock];
      chart.update();
      updateInfo();
    }, 1000);

    function updateInfo() {
      const cash = Math.floor(userHoldings.cash);
      const current = getCurrentPrice();
      const shares = userHoldings.shares[currentStock];
      const avgBuy = userHoldings.avgBuyPrice[currentStock];
      document.getElementById("cash").innerText = cash.toLocaleString();
      document.getElementById("shares").innerText = shares;
      document.getElementById("currentPrice").innerText = current.toLocaleString();
      document.getElementById("maxBuy").innerText = `📈 매수 가능 수량: ${Math.floor(userHoldings.cash / current)}주`;

      const profitEl = document.getElementById("profit");
      if (shares > 0 && avgBuy !== null) {
        const totalBuy = avgBuy * shares;
        const totalNow = current * shares;
        const diff = totalNow - totalBuy;
        const rate = ((diff / totalBuy) * 100).toFixed(2);
        profitEl.innerText = `${diff >= 0 ? '+' : ''}${diff.toLocaleString()}원 (${rate}%)`;
        profitEl.style.color = diff >= 0 ? 'green' : 'red';
      } else {
        profitEl.innerText = '0원 (0%)';
        profitEl.style.color = 'black';
      }
      updateRanking();
    }

    function updateRanking() {
      const rankList = document.getElementById('rankList');
      const currentValue = Object.keys(userHoldings.shares).reduce((sum, stock) => {
        return sum + userHoldings.shares[stock] * stockData[stock].slice(-1)[0];
      }, 0);
      const total = currentValue + userHoldings.cash;
      const profitRate = ((total - 50000) / 50000 * 100).toFixed(2);
      rankList.innerHTML = `<li>${userName} : ${profitRate}%</li>`;
    }

    function logTrade(type, price, quantity, profit, rate) {
      const table = document.getElementById("tradeLog").querySelector("tbody");
      const row = document.createElement("tr");
      const time = new Date().toLocaleTimeString();
      const cells = [
        time, currentStock, type,
        price.toLocaleString(), quantity,
        (price * quantity).toLocaleString(),
        profit === 0 ? '-' : profit.toLocaleString(),
        rate === "0%" ? '-' : rate
      ];
      cells.forEach(text => {
        const td = document.createElement("td");
        td.innerText = text;
        row.appendChild(td);
      });
      table.prepend(row);
    }

    selectStock(currentStock);
  </script>
</body>
</html>
