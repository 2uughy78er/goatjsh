<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>📈 모의 주식 시뮬레이터</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      background: #121212;
      color: #eee;
      transition: background 0.3s, color 0.3s;
    }
    body.light {
      background: #f7f9fb;
      color: #222;
    }
    h1 {
      text-align: center;
      margin-bottom: 20px;
    }
    .panel {
      background: #222;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.8);
      transition: background 0.3s, box-shadow 0.3s;
    }
    body.light .panel {
      background: white;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    #stockChart {
      width: 100%;
      height: 300px;
      background: transparent;
    }
    textarea {
      width: 100%;
      height: 100px;
      background: #222;
      color: #eee;
      border: none;
      border-radius: 8px;
      padding: 10px;
      resize: none;
      transition: background 0.3s, color 0.3s;
    }
    body.light textarea {
      background: #f9f9f9;
      color: #222;
    }
    button {
      cursor: pointer;
      border: none;
      border-radius: 8px;
      padding: 10px 16px;
      margin-right: 8px;
      background: #444;
      color: #eee;
      font-weight: bold;
      transition: background 0.3s;
    }
    button:hover {
      background: #666;
    }
    body.light button {
      background: #ddd;
      color: #222;
    }
    body.light button:hover {
      background: #bbb;
    }
    #newsAlert {
      position: fixed;
      top: 0;
      left: 50%;
      transform: translateX(-50%);
      background: #fffae6;
      color: #333;
      padding: 10px 20px;
      border-radius: 0 0 12px 12px;
      box-shadow: 0 3px 6px rgba(0,0,0,0.2);
      font-weight: bold;
      display: none;
      z-index: 9999;
      max-width: 80%;
      text-align: center;
      user-select: none;
    }
    #toggleThemeBtn {
      background: #007bff;
      color: white;
      margin-bottom: 20px;
    }
    #toggleThemeBtn:hover {
      background: #0056b3;
    }
    .status-row {
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 10px;
    }
    .status-row > div {
      flex: 1 1 30%;
      min-width: 150px;
    }
    #stockInfo > div {
      margin-bottom: 8px;
      padding: 8px;
      background: #333;
      border-radius: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    body.light #stockInfo > div {
      background: #f0f0f0;
      color: #222;
    }
    #stockInfo b {
      flex: 1 1 120px;
    }
    #stockInfo span {
      min-width: 90px;
      text-align: right;
    }
  </style>
</head>
<body>
  <button id="toggleThemeBtn">🌙 다크/라이트 모드 토글</button>
  <h1>📈 모의 주식 시뮬레이터</h1>

  <div id="newsAlert"></div>

  <div class="panel status-row">
    <div>💰 자산: <span id="cash"></span>원</div>
    <div>총 평가금액: <span id="totalValue"></span>원</div>
    <div>수익률: <span id="roi"></span>%</div>
  </div>

  <div class="panel">
    <label for="stockSelect">종목 선택:</label>
    <select id="stockSelect"></select>
    <input type="number" id="amount" value="1" min="1" style="width:70px; margin-left:10px;">
    <button onclick="buyStock()">매수</button>
    <button onclick="sellStock()">매도</button>
    <button onclick="shortStock()">숏 매수</button>
    <button onclick="shortSellStock()">숏 매도</button>
  </div>

  <div class="panel" id="stockInfo"></div>

  <div class="panel">
    <canvas id="stockChart"></canvas>
  </div>

  <div class="panel">
    <h3>📘 거래 로그</h3>
    <textarea id="logArea" readonly></textarea>
  </div>

  <div class="panel">
    <button onclick="resetAllData()" style="background: red; color: white;">🗑️ 초기화</button>
  </div>

  <script>
    const initialPrices = {
      '삼성전자': 70000,
      '현대차': 180000,
      'LG에너지솔루션': 400000,
      '카카오': 60000,
      '네이버': 200000,
      'SK하이닉스': 130000,
      '삼성SDI': 600000,
      'POSCO': 350000,
      '한화솔루션': 50000,
      '셀트리온': 160000,
      '씨젠': 30000,
      '두산에너빌리티': 25000,
      'HMM': 15000,
      '팬오션': 10000,
      '한국전력': 1000
    };

    const newsList = [
      { stock: '삼성전자', text: '삼성전자, 신제품 대박 기대감' },
      { stock: '현대차', text: '현대차, 신차 발표 임박' },
      { stock: 'LG에너지솔루션', text: 'LG에너지솔루션, 배터리 공급 계약 체결' },
      { stock: '카카오', text: '카카오, 신규 서비스 출시' },
      { stock: '네이버', text: '네이버, AI 기술 투자 확대' },
      { stock: 'SK하이닉스', text: 'SK하이닉스, 반도체 가격 상승' },
      { stock: '삼성SDI', text: '삼성SDI, 전기차 배터리 수주 증가' },
      { stock: 'POSCO', text: 'POSCO, 철강 수출 호조' },
      { stock: '한화솔루션', text: '한화솔루션, 태양광 프로젝트 수주' },
      { stock: '셀트리온', text: '셀트리온, 신약 임상 성공' },
      { stock: '씨젠', text: '씨젠, 진단키트 수출 확대' },
      { stock: '두산에너빌리티', text: '두산에너빌리티, 친환경 에너지 투자' },
      { stock: 'HMM', text: 'HMM, 물동량 증가 기대' },
      { stock: '팬오션', text: '팬오션, 해운 운임 상승' },
      { stock: '한국전력', text: '한국전력, 전기요금 동결 발표' },
      // 더 추가 가능 (100개 채우기 위해 반복 예시)
      // 실제로는 다양한 뉴스를 다채롭게 배열해 주세요.
    ];

    // 100개 채우기 위해 복사 반복 (예시용)
    while(newsList.length < 100) {
      newsList.push(...newsList.slice(0, 15).map(n => ({ stock: n.stock, text: n.text })));
    }
    newsList.length = 100; // 정확히 100개로 제한

    let prices = JSON.parse(localStorage.getItem('stockPrices')) || structuredClone(initialPrices);
    let stocks = Object.entries(prices).map(([name, price]) => ({ name, price }));

    let portfolio = JSON.parse(localStorage.getItem('portfolio')) || {};
    let cash = parseInt(localStorage.getItem('cash') || "100000");
    let logs = JSON.parse(localStorage.getItem('logs')) || [];
    let currentStock = stocks[0].name;
    let chartsData = {};
    let currentChart = null;

    // 수수료 5%
    const feeRate = 0.05;

    function saveAll() {
      localStorage.setItem('portfolio', JSON.stringify(portfolio));
      localStorage.setItem('cash', cash);
      localStorage.setItem('logs', JSON.stringify(logs));
      const updatedPrices = {};
      stocks.forEach(s => updatedPrices[s.name] = s.price);
      localStorage.setItem('stockPrices', JSON.stringify(updatedPrices));
    }

    function updateUI() {
      document.getElementById('cash').textContent = cash.toLocaleString();
      let totalVal = cash;
      for (const s of stocks) {
        const hold = portfolio[s.name]?.long || 0;
        const shortHold = portfolio[s.name]?.short || 0;
        totalVal += s.price * hold;
        // 숏 포지션 평가 (주가가 떨어지면 이익)
        if(shortHold) {
          // 평가손익은 매수시 주가 - 현재 주가
          const avgShortPrice = portfolio[s.name].shortAvgPrice || s.price;
          totalVal += (avgShortPrice - s.price) * shortHold;
        }
      }
      document.getElementById('totalValue').textContent = totalVal.toLocaleString();
      let roiVal = ((totalVal - 100000) / 100000 * 100).toFixed(2);
      document.getElementById('roi').textContent = roiVal;

      // 포트폴리오 정보 업데이트
      const infoDiv = document.getElementById('stockInfo');
      infoDiv.innerHTML = '';
      for (const s of stocks) {
        const longAmt = portfolio[s.name]?.long || 0;
        const shortAmt = portfolio[s.name]?.short || 0;
        const item = document.createElement('div');
        item.innerHTML = `<b>${s.name}</b> 현재가: ${s.price.toLocaleString()}원 
          <span>롱 보유: ${longAmt}</span> <span>숏 보유: ${shortAmt}</span>`;
        infoDiv.appendChild(item);
      }
    }

    function logAction(text) {
      const time = new Date().toLocaleTimeString();
      logs.push(`[${time}] ${text}`);
      if(logs.length > 100) logs.shift();
      const logArea = document.getElementById('logArea');
      logArea.value = logs.join('\n');
      logArea.scrollTop = logArea.scrollHeight;
      saveAll();
    }

    function buyStock() {
      const amt = parseInt(document.getElementById('amount').value);
      if(amt <= 0 || isNaN(amt)) return alert("올바른 매수 수량을 입력하세요.");
      const stock = stocks.find(s => s.name === currentStock);
      if(!stock) return;
      const totalCost = Math.floor(stock.price * amt * (1 + feeRate));
      if(cash < totalCost) return alert("잔액이 부족합니다.");
      cash -= totalCost;
      if(!portfolio[currentStock]) portfolio[currentStock] = {long:0, short:0, shortAvgPrice: 0};
      portfolio[currentStock].long += amt;
      logAction(`매수: ${currentStock} ${amt}주, 비용 ${totalCost.toLocaleString()}원 (수수료 포함)`);
      updateUI();
      saveAll();
      updateChartData(currentStock, stock.price);
    }

    function sellStock() {
      const amt = parseInt(document.getElementById('amount').value);
      if(amt <= 0 || isNaN(amt)) return alert("올바른 매도 수량을 입력하세요.");
      if(!portfolio[currentStock] || portfolio[currentStock].long < amt) return alert("보유 주식이 부족합니다.");
      const stock = stocks.find(s => s.name === currentStock);
      if(!stock) return;
      const totalGain = Math.floor(stock.price * amt * (1 - feeRate));
      portfolio[currentStock].long -= amt;
      cash += totalGain;
      logAction(`매도: ${currentStock} ${amt}주, 수익 ${totalGain.toLocaleString()}원 (수수료 포함)`);
      updateUI();
      saveAll();
      updateChartData(currentStock, stock.price);
    }

    // 숏 매수 - 자산 소모, 주가 하락 시 이익
    function shortStock() {
      const amt = parseInt(document.getElementById('amount').value);
      if(amt <= 0 || isNaN(amt)) return alert("올바른 수량을 입력하세요.");
      const stock = stocks.find(s => s.name === currentStock);
      if(!stock) return;
      const totalCost = Math.floor(stock.price * amt * (1 + feeRate));
      if(cash < totalCost) return alert("잔액이 부족합니다.");
      cash -= totalCost;
      if(!portfolio[currentStock]) portfolio[currentStock] = {long:0, short:0, shortAvgPrice: 0};
      // 숏 매수는 주가 하락 시 이익, 평균 숏 가격 계산
      const prevShort = portfolio[currentStock].short || 0;
      const prevAvg = portfolio[currentStock].shortAvgPrice || 0;
      const newAvg = prevShort === 0 ? stock.price : ((prevAvg * prevShort) + (stock.price * amt)) / (prevShort + amt);
      portfolio[currentStock].short = prevShort + amt;
      portfolio[currentStock].shortAvgPrice = newAvg;
      logAction(`숏 매수: ${currentStock} ${amt}주, 비용 ${totalCost.toLocaleString()}원 (수수료 포함)`);
      updateUI();
      saveAll();
      updateChartData(currentStock, stock.price);
    }

    // 숏 매도 - 포지션 정리, 수익 실현
    function shortSellStock() {
      const amt = parseInt(document.getElementById('amount').value);
      if(amt <= 0 || isNaN(amt)) return alert("올바른 수량을 입력하세요.");
      if(!portfolio[currentStock] || portfolio[currentStock].short < amt) return alert("보유 숏 포지션이 부족합니다.");
      const stock = stocks.find(s => s.name === currentStock);
      if(!stock) return;
      // 숏 매도 시 가격 차익 실현: (평균 숏 매수 가격 - 현재 가격) * amt - 수수료
      const avgShortPrice = portfolio[currentStock].shortAvgPrice;
      let profit = (avgShortPrice - stock.price) * amt;
      profit = Math.floor(profit * (1 - feeRate)); // 수수료 차감
      portfolio[currentStock].short -= amt;
      if(portfolio[currentStock].short === 0) portfolio[currentStock].shortAvgPrice = 0;
      cash += (profit + Math.floor(stock.price * amt * (1 - feeRate))); 
      // 실제 현금 유입: 숏 매수 비용 + 이익 실현
      logAction(`숏 매도: ${currentStock} ${amt}주, 수익 ${profit.toLocaleString()}원 (수수료 포함)`);
      updateUI();
      saveAll();
      updateChartData(currentStock, stock.price);
    }

    // 차트 초기화 및 데이터 관리
    const ctx = document.getElementById('stockChart').getContext('2d');
    function createChart(stockName) {
      if(currentChart) currentChart.destroy();
      const data = {
        labels: [],
        datasets: [{
          label: stockName,
          data: [],
          borderColor: 'lime',
          backgroundColor: 'transparent',
          tension: 0.3,
          pointRadius: 0,
          borderWidth: 2,
        }]
      };
      currentChart = new Chart(ctx, {
        type: 'line',
        data,
        options: {
          animation: false,
          scales: {
            x: { display: false },
            y: { beginAtZero: false }
          },
          plugins: {
            legend: { labels: { color: document.body.classList.contains('light') ? '#222' : '#eee' } }
          }
        }
      });
      chartsData[stockName] = [];
    }
    function updateChartData(stockName, price) {
      if(!chartsData[stockName]) chartsData[stockName] = [];
      let arr = chartsData[stockName];
      arr.push(price);
      if(arr.length > 50) arr.shift();
      if(currentStock === stockName && currentChart) {
        currentChart.data.labels = arr.map((_, i) => '');
        currentChart.data.datasets[0].data = arr;
        currentChart.update();
      }
    }

    // 폭락, 폭등 및 뉴스 이벤트 관련
    function applyRandomCrashOrRise() {
      const targetIndex = Math.floor(Math.random() * stocks.length);
      const target = stocks[targetIndex];
      const crashOrRise = Math.random() < 0.5 ? 'crash' : 'rise';
      if(crashOrRise === 'crash') {
        const rate = Math.random() * 0.3 + 0.7; // 70% ~ 100% 폭락
        target.price = Math.max(1, Math.floor(target.price * (1 - rate)));
        logAction(`💥 폭락: ${target.name} -${Math.floor(rate*100)}%`);
      } else {
        const rate = Math.random() * 0.2 + 1.0; // 100% ~ 120% 폭등
        target.price = Math.floor(target.price * rate);
        logAction(`🚀 폭등: ${target.name} +${Math.floor((rate-1)*100)}%`);
      }
      updateChartData(target.name, target.price);
      saveAll();
      updateUI();
    }

    // 뉴스 알림 관련
    function showNewsAlert(msg) {
      const alertDiv = document.getElementById('newsAlert');
      alertDiv.textContent = `📰 뉴스: ${msg}`;
      alertDiv.style.display = 'block';
      setTimeout(() => {
        alertDiv.style.display = 'none';
      }, 5000);
    }

    function applyNewsEvent() {
      const news = newsList[Math.floor(Math.random() * newsList.length)];
      const stock = stocks.find(s => s.name === news.stock);
      if(!stock) return;

      const isRise = Math.random() < 0.5;
      const rate = Math.random() * 0.3 + 0.7; // 70% ~ 100% 변화율

      if(isRise) {
        stock.price = Math.floor(stock.price * (1 + rate));
        logAction(`📰 뉴스 상승: ${news.text} (${stock.name} +${Math.floor(rate*100)}%)`);
        showNewsAlert(`${news.text} (${stock.name} +${Math.floor(rate*100)}%)`);
      } else {
        stock.price = Math.max(1, Math.floor(stock.price * (1 - rate)));
        logAction(`📰 뉴스 하락: ${news.text} (${stock.name} -${Math.floor(rate*100)}%)`);
        showNewsAlert(`${news.text} (${stock.name} -${Math.floor(rate*100)}%)`);
      }
      updateChartData(stock.name, stock.price);
      saveAll();
      updateUI();
    }

    // UI 이벤트 및 초기화
    const stockSelect = document.getElementById('stockSelect');
    stockSelect.addEventListener('change', () => {
      currentStock = stockSelect.value;
      createChart(currentStock);
      if(chartsData[currentStock] && chartsData[currentStock].length) {
        currentChart.data.labels = chartsData[currentStock].map(() => '');
        currentChart.data.datasets[0].data = chartsData[currentStock];
        currentChart.update();
      }
      updateUI();
    });

    function populateStockSelect() {
      stockSelect.innerHTML = '';
      stocks.forEach(s => {
        const opt = document.createElement('option');
        opt.value = s.name;
        opt.textContent = s.name;
        stockSelect.appendChild(opt);
      });
      stockSelect.value = currentStock;
    }

    function resetAllData() {
      if(!confirm("정말 초기화 하시겠습니까? 저장된 모든 데이터가 삭제됩니다.")) return;
      localStorage.clear();
      location.reload();
    }

    // 다크/라이트 모드 토글
    const toggleThemeBtn = document.getElementById('toggleThemeBtn');
    toggleThemeBtn.addEventListener('click', () => {
      document.body.classList.toggle('light');
      if(currentChart) {
        currentChart.options.plugins.legend.labels.color = document.body.classList.contains('light') ? '#222' : '#eee';
        currentChart.update();
      }
    });

    // 주기적 이벤트 설정
    setInterval(() => {
      // 매 90초마다 뉴스 이벤트
      applyNewsEvent();
    }, 60000); // 60초

    setInterval(() => {
      // 매 100초마다 폭등/폭락 한 종목
      applyRandomCrashOrRise();
    }, 100000);

    // 매 3초마다 현재 차트 갱신 (주가 약간 변동 포함)
    setInterval(() => {
      stocks.forEach(s => {
        // 약간 소폭 변동 (±1%)
        const changePercent = (Math.random() * 2 - 1) * 0.01;
        s.price = Math.max(1, Math.floor(s.price * (1 + changePercent)));
        updateChartData(s.name, s.price);
      });
      if(currentChart) {
        currentChart.data.datasets[0].data = chartsData[currentStock];
        currentChart.update();
      }
      updateUI();
      saveAll();
    }, 3000);

    // 초기화 함수 실행
    init();
  </script>
</body>
</html>
