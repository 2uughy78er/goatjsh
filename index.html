<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ì‹¤ì‹œê°„ ì£¼ì‹ ê±°ë˜ ì‹œë®¬ë ˆì´í„° - ì‚¬ìš©ìë³„ ìˆ˜ìµë¥  ë­í‚¹</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      display: flex;
      font-family: Arial, sans-serif;
      margin: 0;
      height: 100vh;
    }
    .sidebar {
      width: 200px;
      background: #f5f5f5;
      padding: 10px;
      overflow-y: auto;
      box-sizing: border-box;
    }
    .chart-container {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      box-sizing: border-box;
    }
    .stock-list button {
      display: block;
      width: 100%;
      margin-bottom: 5px;
    }
    .controls {
      margin-top: 10px;
    }
    .info {
      margin-top: 10px;
    }
    .log-table, .log-table th, .log-table td {
      border: 1px solid #ccc;
      border-collapse: collapse;
    }
    .log-table th, .log-table td {
      padding: 5px;
    }
    .rankings {
      margin-top: 20px;
      font-size: 14px;
    }
    .max-buy {
      margin-top: 5px;
      font-size: 14px;
      color: #333;
    }

    /* --- ëª¨ë°”ì¼ ì„¸ë¡œ í™”ë©´ ëŒ€ì‘ --- */
    @media (max-height: 700px), (max-width: 480px) {
      body {
        flex-direction: column;
        height: 100vh;
      }
      .sidebar {
        width: 100%;
        height: 130px;
        overflow-x: auto;
        overflow-y: hidden;
        white-space: nowrap;
        padding: 5px 10px;
        display: flex;
        flex-wrap: nowrap;
        align-items: center;
        box-sizing: border-box;
      }
      .stock-list button {
        display: inline-block;
        width: auto;
        margin-right: 8px;
        margin-bottom: 0;
        white-space: normal;
        flex-shrink: 0;
      }
      .chart-container {
        height: calc(100vh - 130px);
        overflow-y: auto;
        padding: 10px;
      }
    }
  </style>
</head>
<body>
  <div class="sidebar">
    <h2 style="flex-shrink: 0; margin-right: 15px;">ì¢…ëª© ì„ íƒ</h2>
    <div class="stock-list" id="stockButtons"></div>

    <div class="rankings">
      <h3>ğŸ† ìˆ˜ìµë¥  ìˆœìœ„</h3>
      <ul id="rankList"></ul>
    </div>

    <div style="margin-top:20px;">
      <label for="userNameInput">ì‚¬ìš©ì ì´ë¦„:</label><br />
      <input type="text" id="userNameInput" placeholder="ì´ë¦„ ì…ë ¥" />
      <button id="setNameBtn">ì„¤ì •</button>
    </div>
  </div>

  <div class="chart-container">
    <h1 id="stock-title">ì´ˆê¸°íˆ¬ì</h1>
    <div style="font-size: 18px; margin-bottom: 15px;">
      í˜„ì¬ ì£¼ê°€: <span id="currentPrice" style="font-weight: bold;">0</span>ì›
    </div>

    <div class="controls">
      <input type="number" id="tradeAmount" value="1" min="1" />
      <button onclick="buyStock()">ğŸŸ¢ ë§¤ìˆ˜</button>
      <button onclick="sellStock()">ğŸ”´ ë§¤ë„</button>
      <div class="max-buy" id="maxBuy"></div>
      <div class="info">
        ğŸ’° ìê¸ˆ: <span id="cash">0</span>ì› |
        ğŸ’¼ ë³´ìœ  ìˆ˜ëŸ‰: <span id="shares">0</span>ê°œ<br />
        ğŸ“ˆ ì†ìµ: <span id="profit" style="font-weight: bold;">0ì› (0%)</span>
      </div>
    </div>

    <canvas id="stockChart" width="1200" height="400"></canvas>

    <h3>ğŸ“‹ ê±°ë˜ ë‚´ì—­</h3>
    <table class="log-table" id="tradeLog">
      <thead>
        <tr>
          <th>ì‹œê°„</th>
          <th>ì¢…ëª©</th>
          <th>êµ¬ë¶„</th>
          <th>ë‹¨ê°€</th>
          <th>ìˆ˜ëŸ‰</th>
          <th>ì´ì•¡</th>
          <th>ì†ìµ</th>
          <th>ìˆ˜ìµë¥ </th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    // ì´ˆê¸° ì„¸íŒ… ë³€ìˆ˜
    const stocks = ['ì´ˆê¸°íˆ¬ì', 'ì‚¼ì„±ì „ì', 'í˜„ëŒ€ì°¨', 'LGì „ì', 'ì¹´ì¹´ì˜¤', 'ë„¤ì´ë²„', 'ì…€íŠ¸ë¦¬ì˜¨', 'POSCO', 'SKí•˜ì´ë‹‰ìŠ¤', 'ê¸°ì•„', 'í•œí™”ì†”ë£¨ì…˜', 'NAVER', 'ì‹ í•œì§€ì£¼', 'KBê¸ˆìœµ', 'ì‚¼ì„±ë°”ì´ì˜¤ë¡œì§ìŠ¤', 'ë¡¯ë°ì¼€ë¯¸ì¹¼'];
    const startPrices = {
      'ì´ˆê¸°íˆ¬ì': 1000, 'ì‚¼ì„±ì „ì': 60000, 'í˜„ëŒ€ì°¨': 220000, 'LGì „ì': 130000,
      'ì¹´ì¹´ì˜¤': 70000, 'ë„¤ì´ë²„': 300000, 'ì…€íŠ¸ë¦¬ì˜¨': 250000, 'POSCO': 300000,
      'SKí•˜ì´ë‹‰ìŠ¤': 110000, 'ê¸°ì•„': 85000, 'í•œí™”ì†”ë£¨ì…˜': 36000,
      'NAVER': 300000, 'ì‹ í•œì§€ì£¼': 40000, 'KBê¸ˆìœµ': 47000,
      'ì‚¼ì„±ë°”ì´ì˜¤ë¡œì§ìŠ¤': 850000, 'ë¡¯ë°ì¼€ë¯¸ì¹¼': 300000
    };
    const maxDataLength = 50;
    const initialCash = 50000;

    // ì‚¬ìš©ì ë°ì´í„° ê´€ë¦¬ ë³€ìˆ˜
    let currentUserName = null;  // í˜„ì¬ ì ‘ì†í•œ ì‚¬ìš©ì ì´ë¦„
    let usersData = {}; // ëª¨ë“  ì‚¬ìš©ì ë°ì´í„° { userName: { cash, shares, avgBuyPrice, trades[] } }
    let currentStock = stocks[0];
    let currentIndex = 50;
    let stockData = {}; // {stockName: [price,...]}
    let chart, data;

    // DOM ìš”ì†Œë“¤
    const stockButtonsDiv = document.getElementById('stockButtons');
    const userNameInput = document.getElementById('userNameInput');
    const setNameBtn = document.getElementById('setNameBtn');
    const rankList = document.getElementById('rankList');

    // ì´ˆê¸° ë°ì´í„° ìƒì„± í•¨ìˆ˜
    function getRandomPrice(prevPrice) {
      let changePercent = (Math.random() - 0.5) * 0.06; // -3% ~ +3%
      let newPrice = prevPrice * (1 + changePercent);
      return Math.max(1, Math.round(newPrice));
    }
    function generateInitialData(startPrice) {
      const arr = [startPrice];
      for (let i = 1; i < maxDataLength; i++) arr.push(getRandomPrice(arr[i - 1]));
      return arr;
    }

    // ëª¨ë“  ì¢…ëª© ê°€ê²© ë°ì´í„° ì´ˆê¸°í™”
    function initStockData() {
      stocks.forEach(stock => {
        stockData[stock] = generateInitialData(startPrices[stock]);
      });
    }

    // ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì—ì„œ ì‚¬ìš©ì ì „ì²´ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
    function loadUsersData() {
      const dataStr = localStorage.getItem('usersData');
      if (dataStr) {
        try {
          usersData = JSON.parse(dataStr);
        } catch {
          usersData = {};
        }
      } else {
        usersData = {};
      }
    }
    // ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì— ì‚¬ìš©ì ì „ì²´ ë°ì´í„° ì €ì¥
    function saveUsersData() {
      localStorage.setItem('usersData', JSON.stringify(usersData));
    }

    // í˜„ì¬ ì‚¬ìš©ì ë°ì´í„° ì´ˆê¸°í™” (ì²˜ìŒ ì ‘ì† ì‹œ)
    function initCurrentUser(userName) {
      currentUserName = userName;
      if (!usersData[userName]) {
        usersData[userName] = {
          cash: initialCash,
          shares: {},
          avgBuyPrice: {},
          trades: []
        };
        stocks.forEach(s => {
          usersData[userName].shares[s] = 0;
          usersData[userName].avgBuyPrice[s] = null;
        });
        saveUsersData();
      }
      userNameInput.value = currentUserName;
    }

    // UIì— ì¢…ëª© ë²„íŠ¼ ìƒì„±
    function createStockButtons() {
      stockButtonsDiv.innerHTML = '';
      stocks.forEach(stock => {
        const btn = document.createElement('button');
        btn.textContent = stock;
        btn.onclick = () => selectStock(stock);
        stockButtonsDiv.appendChild(btn);
      });
    }

    // ì°¨íŠ¸ ì´ˆê¸°í™”
    function initChart() {
      const ctx = document.getElementById('stockChart').getContext('2d');
      data = {
        labels: Array.from({ length: maxDataLength }, (_, i) => i.toString()),
        datasets: [{
          label: currentStock,
          borderColor: 'rgb(75, 192, 192)',
          backgroundColor: 'rgba(75, 192, 192, 0.2)',
          data: [...stockData[currentStock]],
          tension: 0.3
        }]
      };
      chart = new Chart(ctx, {
        type: 'line',
        data: data,
        options: {
          responsive: true,
          animation: false,
          scales: {
            x: { title: { display: true, text: 'ì‹œê°„' } },
            y: { title: { display: true, text: 'ê°€ê²©' }, beginAtZero: false }
          }
        }
      });
    }

    // í˜„ì¬ ì„ íƒëœ ì¢…ëª© ë³€ê²½ ì²˜ë¦¬
    function selectStock(stock) {
      currentStock = stock;
      document.getElementById('stock-title').innerText = stock;
      data.datasets[0].label = stock;
      data.datasets[0].data = stockData[stock];
      data.labels = Array.from({ length: stockData[stock].length }, (_, i) => i.toString());
      chart.update();
      updateInfo();
    }

    // í˜„ì¬ ê°€ê²© ê°€ì ¸ì˜¤ê¸°
    function getCurrentPrice() {
      return stockData[currentStock][stockData[currentStock].length - 1];
    }

    // í˜„ì¬ ì‚¬ìš©ì ë°ì´í„° ì°¸ì¡°
    function getCurrentUserData() {
      if (!currentUserName || !usersData[currentUserName]) return null;
      return usersData[currentUserName];
    }

    // ë§¤ìˆ˜ í•¨ìˆ˜
    function buyStock() {
      const userData = getCurrentUserData();
      if (!userData) { alert('ì‚¬ìš©ì ì´ë¦„ì„ ë¨¼ì € ì„¤ì •í•˜ì„¸ìš”.'); return; }

      const price = getCurrentPrice();
      const quantity = parseInt(document.getElementById('tradeAmount').value);
      if (quantity <= 0) return alert('1 ì´ìƒ ìˆ˜ëŸ‰ì„ ì…ë ¥í•˜ì„¸ìš”.');
      const totalCost = price * quantity;
      if (userData.cash >= totalCost) {
        const currentShares = userData.shares[currentStock];
        const currentAvg = userData.avgBuyPrice[currentStock];
        const newTotalShares = currentShares + quantity;
        userData.avgBuyPrice[currentStock] = currentShares === 0 ? price : (currentAvg * currentShares + price * quantity) / newTotalShares;
        userData.cash -= totalCost;
        userData.shares[currentStock] += quantity;
        logTrade("ë§¤ìˆ˜", price, quantity, 0, "0%");
        saveUsersData();
        updateInfo();
        updateRanking();
      } else alert("ìê¸ˆì´ ë¶€ì¡±í•©ë‹ˆë‹¤.");
    }

    // ë§¤ë„ í•¨ìˆ˜
    function sellStock() {
      const userData = getCurrentUserData();
      if (!userData) { alert('ì‚¬ìš©ì ì´ë¦„ì„ ë¨¼ì € ì„¤ì •í•˜ì„¸ìš”.'); return; }

      const quantity = parseInt(document.getElementById('tradeAmount').value);
      if (quantity <= 0) return alert('1 ì´ìƒ ìˆ˜ëŸ‰ì„ ì…ë ¥í•˜ì„¸ìš”.');
      const owned = userData.shares[currentStock];
      if (owned >= quantity) {
        const sellPrice = getCurrentPrice();
        const buyPrice = userData.avgBuyPrice[currentStock];
        const profitPerShare = sellPrice - buyPrice;
        const profitTotal = profitPerShare * quantity;
        const profitRate = buyPrice === 0 ? 0 : ((profitPerShare / buyPrice) * 100).toFixed(2);
        userData.cash += sellPrice * quantity;
        userData.shares[currentStock] -= quantity;
        if (userData.shares[currentStock] === 0) userData.avgBuyPrice[currentStock] = null;
        logTrade("ë§¤ë„", sellPrice, quantity, profitTotal, profitRate + "%");
        saveUsersData();
        updateInfo();
        updateRanking();
      } else alert("ë³´ìœ  ìˆ˜ëŸ‰ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.");
    }

    // ì£¼ê°€ ë°ì´í„° ì—…ë°ì´íŠ¸ (1ì´ˆë§ˆë‹¤)
    function updateStockPrices() {
      stocks.forEach(stock => {
        const prices = stockData[stock];
        const prevPrice = prices[prices.length - 1];
        const newPrice = getRandomPrice(prevPrice);
        prices.push(newPrice);
        if (prices.length > maxDataLength) prices.shift();
      });
      data.labels.push((currentIndex++).toString());
      if (data.labels.length > maxDataLength) data.labels.shift();
      data.datasets[0].data = stockData[currentStock];
      chart.update();
      updateInfo();
      updateRanking();
    }

    // ì •ë³´ ì—…ë°ì´íŠ¸ (í˜„ì¬ ì‚¬ìš©ì ìê¸ˆ, ë³´ìœ , ì†ìµ ë“±)
    function updateInfo() {
      const userData = getCurrentUserData();
      if (!userData) return;

      const cash = Math.floor(userData.cash);
      const current = getCurrentPrice();
      const shares = userData.shares[currentStock];
      const avgBuy = userData.avgBuyPrice[currentStock];
      document.getElementById("cash").innerText = cash.toLocaleString();
      document.getElementById("shares").innerText = shares;
      document.getElementById("currentPrice").innerText = current.toLocaleString();
      document.getElementById("maxBuy").innerText = `ğŸ“ˆ ë§¤ìˆ˜ ê°€ëŠ¥ ìˆ˜ëŸ‰: ${Math.floor(userData.cash / current)}ê°œ`;

      let profit = 0, profitPercent = 0;
      if (avgBuy !== null && shares > 0) {
        profit = (current - avgBuy) * shares;
        profitPercent = ((current - avgBuy) / avgBuy) * 100;
      }
      const profitElem = document.getElementById("profit");
      profitElem.innerText = `${profit.toLocaleString()}ì› (${profitPercent.toFixed(2)}%)`;
      profitElem.style.color = profit > 0 ? "green" : profit < 0 ? "red" : "black";

      updateTradeLog();
    }

    // ê±°ë˜ ë‚´ì—­ ë¡œê·¸ ê¸°ë¡ í•¨ìˆ˜
    function logTrade(type, price, quantity, profit, profitRate) {
      const userData = getCurrentUserData();
      if (!userData) return;

      const now = new Date();
      const timeStr = now.toLocaleTimeString();
      userData.trades.push({
        time: timeStr,
        stock: currentStock,
        type,
        price,
        quantity,
        total: price * quantity,
        profit,
        profitRate
      });

      // ê±°ë˜ë‚´ì—­ ë„ˆë¬´ ê¸¸ë©´ 50ê°œê¹Œì§€ë§Œ ìœ ì§€
      if (userData.trades.length > 50) userData.trades.shift();

      saveUsersData();
    }

    // ê±°ë˜ ë‚´ì—­ UI ê°±ì‹ 
    function updateTradeLog() {
      const userData = getCurrentUserData();
      const tbody = document.querySelector("#tradeLog tbody");
      tbody.innerHTML = "";
      if (!userData) return;
      userData.trades.slice().reverse().forEach(trade => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${trade.time}</td>
          <td>${trade.stock}</td>
          <td>${trade.type}</td>
          <td>${trade.price.toLocaleString()}</td>
          <td>${trade.quantity}</td>
          <td>${trade.total.toLocaleString()}</td>
          <td style="color:${trade.profit > 0 ? 'green' : trade.profit < 0 ? 'red' : 'black'}">${trade.profit.toLocaleString()}</td>
          <td>${trade.profitRate}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    // ì‚¬ìš©ì ì´ë¦„ ì„¤ì • ë²„íŠ¼ ì´ë²¤íŠ¸
    setNameBtn.onclick = () => {
      const name = userNameInput.value.trim();
      if (!name) return alert("ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.");
      if (name.includes('|')) return alert("ì´ë¦„ì— '|' ë¬¸ìëŠ” ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
      initCurrentUser(name);
      updateInfo();
      updateRanking();
    };

    // ìˆ˜ìµë¥  ê³„ì‚° í•¨ìˆ˜ (ì „ì²´ ì£¼ì‹ í¬í•¨ ìˆ˜ìµë¥ )
    function calculateUserReturn(user) {
      const initialCash = initialCash;
      let totalValue = user.cash;
      stocks.forEach(stock => {
        const shares = user.shares[stock];
        if (shares > 0) {
          const currentPrice = stockData[stock][stockData[stock].length - 1];
          totalValue += shares * currentPrice;
        }
      });
      const gain = totalValue - initialCash;
      const returnRate = (gain / initialCash) * 100;
      return returnRate;
    }

    // ì „ì²´ ì‚¬ìš©ì ìˆ˜ìµë¥  ë­í‚¹ ì—…ë°ì´íŠ¸
    function updateRanking() {
      rankList.innerHTML = '';
      const arr = [];
      for (const name in usersData) {
        const user = usersData[name];
        const ret = calculateUserReturn(user);
        arr.push({ name, ret });
      }
      arr.sort((a, b) => b.ret - a.ret);

      arr.forEach((u, i) => {
        const li = document.createElement('li');
        li.style.fontWeight = (u.name === currentUserName) ? 'bold' : 'normal';
        li.style.color = (u.name === currentUserName) ? '#007bff' : 'black';
        li.textContent = `${i + 1}ìœ„: ${u.name} â€” ${u.ret.toFixed(2)}%`;
        rankList.appendChild(li);
      });
    }

    // ì´ˆê¸°í™” í•¨ìˆ˜
    function init() {
      initStockData();
      loadUsersData();

      // ê¸°ì¡´ì— localStorageì— ì‚¬ìš©ì ì´ë¦„ ìˆìœ¼ë©´ ë¶ˆëŸ¬ì˜¤ê¸°
      const savedName = localStorage.getItem('currentUserName');
      if (savedName && savedName in usersData) {
        currentUserName = savedName;
        userNameInput.value = currentUserName;
      }

      if (!currentUserName) {
        userNameInput.value = '';
      } else {
        initCurrentUser(currentUserName);
      }

      createStockButtons();
      initChart();
      selectStock(currentStock);

      updateInfo();
      updateRanking();

      // ë§¤ì´ˆ ì£¼ê°€ ê°±ì‹  ë° UI ê°±ì‹ 
      setInterval(() => {
        updateStockPrices();
        if(currentUserName) localStorage.setItem('currentUserName', currentUserName);
      }, 1000);
    }

    init();
  </script>
</body>
</html>
